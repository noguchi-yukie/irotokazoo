<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>いろとかずー | Irotokazoo v24 (HTML)</title>
<style>
  :root { --bg:#f6f7fb; --card:#ffffff; --ink:#111827; --muted:#6b7280; --accent:#2563eb }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic","YuGothic",sans-serif;background:var(--bg);color:var(--ink);display:flex;align-items:center;justify-content:center;padding:16px}
  .app{width:min(900px,100%);background:var(--card);border-radius:20px;box-shadow:0 10px 30px rgba(0,0,0,.08);padding:18px 18px 22px}
  header{display:flex;flex-wrap:wrap;align-items:center;gap:10px;justify-content:space-between;margin-bottom:8px}
  header h1{font-size:clamp(18px,3.8vw,24px);margin:0;font-weight:800;letter-spacing:.2px;cursor:pointer}
  .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .controls label{font-size:12px;color:var(--muted)}
  select,.btn{border:1px solid #e5e7eb;background:#fff;padding:8px 10px;border-radius:12px;font-size:14px;display:inline-block}
  select:focus{outline:3px solid rgba(37,99,235,.2);border-color:var(--accent)}
  /* Line break before Start (keeps Start on 2nd row, left aligned) */
  .controls::after{content:""; flex-basis:100%; order:900}
  /* Small, left-aligned black Start button on 2nd row */
  #startBtn{ order:999; align-self:flex-start; margin-top:4px; background:#111; color:#fff; border-color:#111; width:auto; flex:0 0 auto; }
  #startBtn:hover{ filter:brightness(0.9); }

  .panel{background:#fff;border:2px solid #e5e7eb;border-radius:16px;padding:16px;margin-top:6px;position:relative;overflow:hidden}
  .question{font-weight:700;font-size:clamp(16px,3.5vw,20px);margin:0 0 10px}

  .swatch{position:relative;height:190px;border-radius:16px;border:2px solid #e5e7eb;overflow:hidden;display:grid;place-items:center;margin-bottom:14px;user-select:none}
  .bigword{font-weight:900;font-size:clamp(36px,9vw,60px);letter-spacing:.5px;position:relative;z-index:1}

  .confetti{position:absolute;inset:0;pointer-events:none;overflow:hidden;z-index:0}
  .confetti span{position:absolute;width:8px;height:8px;opacity:0;animation:pop .7s ease-out forwards}
  @keyframes pop{0%{transform:translate(var(--x),var(--y)) scale(.6) rotate(0deg);opacity:0}30%{opacity:1}100%{transform:translate(calc(var(--x)*5),calc(var(--y)*5)) scale(1.2) rotate(240deg);opacity:0}}
  .flash{animation:flash 400ms ease-out}
  @keyframes flash{0%{box-shadow:0 0 0 0 rgba(16,185,129,.8)}100%{box-shadow:0 0 0 18px rgba(16,185,129,0)}}

  .choices{display:grid;grid-template-columns:1fr;gap:10px}
  .choice{height:56px;border-radius:14px;font-size:20px;font-weight:800;border:2px solid #e5e7eb;background:#fff;cursor:pointer;transition:transform .05s ease,box-shadow .2s ease;display:flex;align-items:center;justify-content:center}
  .choice:active{transform:translateY(1px)}
  .choice[disabled]{opacity:.7;cursor:not-allowed}
  .colored-text{text-shadow:0 1px 0 rgba(255,255,255,.7),0 0 4px rgba(0,0,0,.25)}
  .choice.color-only{border:none;height:62px}

  .status{display:flex;align-items:center;justify-content:space-between;margin-top:14px;font-size:14px;color:var(--muted);gap:10px;flex-wrap:wrap}
  .score{font-weight:700;color:var(--ink)}
  .badge{padding:2px 8px;background:#eef2ff;color:#3730a3;border-radius:999px;font-weight:700}
  .pill{padding:2px 8px;background:#ecfeff;color:#155e75;border-radius:999px;font-weight:700}

  .center{display:grid;place-items:center;gap:10px;text-align:center;position:relative}
  .bigscore{font-size:clamp(32px,6vw,44px);font-weight:900}
  #fireworksCanvas{position:absolute;inset:0;width:100%;height:100%;pointer-events:none}
  .qrow{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .qmeta{display:flex;gap:8px;align-items:center}
  .qbadge{font-weight:800;font-size:14px;padding:2px 8px;background:#f3f4f6;border-radius:999px;color:#374151}
  #resultConfetti{z-index:2}
</style>
</head>
<body>
  <div class="app">
    <header>
      <h1 id="title">いろとかずー</h1>
      <div class="controls">
        <label for="langSel" id="langLabel">ことば</label>
        <select id="langSel" aria-label="Language">
          <option value="ja">にほんご</option>
          <option value="en">English</option>
        </select>
        <label for="topicSel" id="topicLabel">てーま</label>
        <select id="topicSel">
          <option value="color">いろ</option>
          <option value="number">かず</option>
        </select>
        <span id="colorControls">
          <label for="modeSel" id="modeLabel">もーど</label>
          <select id="modeSel" aria-label="Mode">
            <option value="easy">やさしい（いろつき）</option>
            <option value="hard">むずかしい（くろ）</option>
            <option value="stroop">ことば＋いろぼたん</option>
          </select>
        </span>
        <span id="numberControls" style="display:none">
          <label for="numLvlSel" id="numLvlLabel">れべる</label>
          <select id="numLvlSel">
            <option value="1">1（0〜10）</option>
            <option value="2">2（0〜20）</option>
            <option value="3">3（0〜20＋とくべつ）</option>
          </select>
        </span>
        <label for="playType" id="playTypeLabel">あそびかた</label>
        <select id="playType">
          <option value="time">たいむあたっく</option>
          <option value="count">もんだいすう</option>
        </select>
        <span id="timeWrap">
          <label for="secSel" id="timeLabel">びょう</label>
          <select id="secSel">
            <option>30</option><option selected>60</option><option>90</option>
          </select>
        </span>
        <span id="countWrap" style="display:none">
          <label for="qSel" id="countLabel">もん</label>
          <select id="qSel">
            <option>5</option><option selected>10</option><option>20</option>
          </select>
        </span>
        <button class="btn" id="startBtn" type="button">すたーと</button>
      </div>
    </header>

    <section class="panel" id="gamePanel">
      <div class="qrow"><p class="question" id="question">このいろは なにいろ？</p><div class="qmeta"><span id="qProgress" class="qbadge"></span><span id="qTimer" class="qbadge"></span></div></div>
      <div class="swatch" id="swatch" aria-label="prompt area">
        <div class="confetti" id="confetti"></div>
        <div id="swatchText" class="bigword" style="display:none"></div>
      </div>
      <div class="choices" id="choices"></div>
      <div class="status">
        <div><span class="score" id="scoreLbl">0</span> <span id="scoreUnit">てん</span> ・ <span id="streakLbl" class="badge">0 🔥</span></div>
        <div><span id="timerLbl" class="pill" style="display:none">00:00</span> <span id="progressLbl" class="pill" style="display:none"></span></div>
        <div id="feedback" aria-live="polite"></div>
      </div>
      <div class="footer">
        <button class="btn" id="resetBtn" type="button">りせっと</button>
        <div class="hint" id="hint">やさしい：えらぶ もじのいろ が いろつき。むずかしい：ぜんぶ くろ。ことば＋いろ：ことばは くろ、えらぶのは いろだけ。</div>
      </div>
    </section>

    <section class="panel center" id="resultPanel" style="display:none">
      <canvas id="fireworksCanvas"></canvas>
      <div class="confetti" id="resultConfetti"></div>
      <h2 id="resultTitle" style="margin:0;position:relative;z-index:1;">けっか</h2>
      <div class="bigscore" id="resultText" style="position:relative;z-index:1;"></div>
      <div id="resultDetails" style="position:relative; z-index:1; font-weight:700;"></div>
      <div style="position:relative;z-index:1;"><span id="resultStreak" class="pill"></span></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;position:relative;z-index:1;">
        <button class="btn" id="againBtn" type="button">もういっかい</button>
        <button class="btn" id="homeBtn" type="button">もどる</button>
      </div>
    </section>
  </div>

<script>
// Wrap everything to avoid early execution issues
window.addEventListener('DOMContentLoaded', () => { (function(){
  // ---------- Data ----------
  const COLORS = [
    { key:'black',  en:'Black',   ja:'くろ',   css:'#111827' },
    { key:'red',    en:'Red',     ja:'あか',   css:'#e11d48' },
    { key:'blue',   en:'Blue',    ja:'あお',   css:'#1d4ed8' },
    { key:'green',  en:'Green',   ja:'みどり', css:'#059669' },
    { key:'yellow', en:'Yellow',  ja:'きいろ', css:'#ffeb3b' },
    { key:'orange', en:'Orange',  ja:'おれんじ', css:'#f97316' },
    { key:'purple', en:'Purple',  ja:'むらさき', css:'#7e22ce' },
    { key:'pink',   en:'Pink',    ja:'ぴんく', css:'#ec4899' },
    { key:'brown',  en:'Brown',   ja:'ちゃいろ', css:'#8b5a2b' },
    { key:'gray',   en:'Gray',    ja:'ぐれー', css:'#6b7280' },
  ];

  const NUM_BASE = [
    {num:0, ja:'ぜろ', en:'zero'}, {num:1, ja:'いち', en:'one'}, {num:2, ja:'に', en:'two'}, {num:3, ja:'さん', en:'three'},
    {num:4, ja:'よん', en:'four'}, {num:5, ja:'ご', en:'five'}, {num:6, ja:'ろく', en:'six'}, {num:7, ja:'なな', en:'seven'},
    {num:8, ja:'はち', en:'eight'}, {num:9, ja:'きゅう', en:'nine'}, {num:10, ja:'じゅう', en:'ten'},
    {num:11, ja:'じゅういち', en:'eleven'}, {num:12, ja:'じゅうに', en:'twelve'}, {num:13, ja:'じゅうさん', en:'thirteen'},
    {num:14, ja:'じゅうよん', en:'fourteen'}, {num:15, ja:'じゅうご', en:'fifteen'}, {num:16, ja:'じゅうろく', en:'sixteen'},
    {num:17, ja:'じゅうなな', en:'seventeen'}, {num:18, ja:'じゅうはち', en:'eighteen'}, {num:19, ja:'じゅうきゅう', en:'nineteen'},
    {num:20, ja:'にじゅう', en:'twenty'}
  ];

  const NUM_SPECIAL_JA = [
    {num:100, ja:'ひゃく', en:'hundred'},
    {num:1000, ja:'せん', en:'thousand'},
    {num:10000, ja:'まん', en:'ten thousand'},
    {num:100000000, ja:'おく', en:'hundred million'}
  ];
  const NUM_SPECIAL_EN = [
    {num:100, ja:'ひゃく', en:'hundred'},
    {num:1000, ja:'せん', en:'thousand'},
    {num:1000000, ja:'みりおん', en:'million'},
    {num:1000000000, ja:'びりおん', en:'billion'}
  ];

  const I18N = {
    en: {
      title: "Color & Number Zoo",
      language: "Language",
      topic: "Topic",
      topicColor: "Colors",
      topicNumber: "Numbers",
      mode: "Mode",
      numLevel: "Level",
      numLevelOpts: ["1 (0–10)","2 (0–20)","3 (0–20 + specials)"],
      playType: "Game",
      playTypeOpts: ["Time Attack","Question Count"],
      time: "sec",
      count: "Q",
      questionColorFill: "What color is this?",
      questionColorWord: "Which color does this WORD mean?",
      questionNumber: "What does this NUMBER say?",
      points: "pts",
      reset: "Reset",
      start: "Start",
      hint: "Easy: colored options. Hard: black text. Word+Color: word is black; options are color blocks.",
      modes: { easy: "Easy (colored options)", hard: "Hard (black text)", stroop: "Word + color blocks" },
      correct: "Correct!",
      wrong: "Nice try!",
      finishedTime: s=>`Time up! Score ${s}`,
      finishedCount: (s,t)=>`Finished ${t} Q! Score ${s}`,
      resultTitle: "Results",
      playAgain: "Play again",
      back: "Back",
      bestStreak: s=>`Best streak: ${s}`,
      resultDetails: (s,d)=>`${s} / ${d} correct!`,
      secretOn: "Secret: Kazoo ON",
      secretOff: "Secret: Kazoo OFF"
    },
    ja: {
      title: "いろとかずー",
      language: "ことば",
      topic: "てーま",
      topicColor: "いろ",
      topicNumber: "かず",
      mode: "もーど",
      numLevel: "れべる",
      numLevelOpts: ["1（0〜10）","2（0〜20）","3（0〜20＋とくべつ）"],
      playType: "あそびかた",
      playTypeOpts: ["たいむあたっく","もんだいすう"],
      time: "びょう",
      count: "もん",
      questionColorFill: "このいろは なにいろ？",
      questionColorWord: "この『ことば』は なにいろ？",
      questionNumber: "この『すうじ』は、なんて よむ？",
      points: "てん",
      reset: "りせっと",
      start: "すたーと",
      hint: "やさしい：えらぶ もじのいろ が いろつき。むずかしい：ぜんぶ くろ。ことば＋いろ：ことばは くろ、えらぶのは いろだけ。",
      modes: { easy: "やさしい（いろつき）", hard: "むずかしい（くろ）", stroop: "ことば＋いろぼたん" },
      correct: "せいかい！",
      wrong: "おしい！",
      finishedTime: s=>`じかんぎれ！ ${s}てん`,
      finishedCount: (s,t)=>`${t}もん おわり！ ${s}てん`,
      resultTitle: "けっか",
      playAgain: "もういっかい",
      back: "もどる",
      bestStreak: s=>`れんぞく ${s} かい`,
      resultDetails: (s,d)=>`${d}もんちゅう ${s}もん せいかい！`,
      secretOn: "ひみつ：かずーおん ON",
      secretOff: "ひみつ：かずーおん OFF"
    }
  };

  // ---------- Elements ----------
  const $ = id => document.getElementById(id);
  const langSel=$('langSel'), topicSel=$('topicSel'), modeSel=$('modeSel'), numLvlSel=$('numLvlSel');
  const titleEl=$('title'), question=$('question'), swatch=$('swatch'), swatchText=$('swatchText');
  const choicesWrap=$('choices'), scoreLbl=$('scoreLbl'), streakLbl=$('streakLbl'), scoreUnit=$('scoreUnit');
  const feedback=$('feedback'), hint=$('hint'), resetBtn=$('resetBtn'), confetti=$('confetti');
  const playType=$('playType'), secSel=$('secSel'), qSel=$('qSel'), timeWrap=$('timeWrap'), countWrap=$('countWrap');
  const timerLbl=$('timerLbl'), progressLbl=$('progressLbl'), startBtn=$('startBtn'), qProgress=$('qProgress'), qTimer=$('qTimer');
  const gamePanel=$('gamePanel'), resultPanel=$('resultPanel'), resultTitle=$('resultTitle');
  const resultText=$('resultText'), resultStreak=$('resultStreak'), againBtn=$('againBtn'), homeBtn=$('homeBtn');
  const topicLabel=$('topicLabel'), langLabel=$('langLabel'), modeLabel=$('modeLabel'), numLvlLabel=$('numLvlLabel');
  const playTypeLabel=$('playTypeLabel'), timeLabel=$('timeLabel'), countLabel=$('countLabel');
  const colorControls=$('colorControls'), numberControls=$('numberControls');
  const fireworksCanvas=$('fireworksCanvas'), resultConfetti=$('resultConfetti');

  // ---------- State ----------
  let score=0, streak=0, bestStreak=0, currentCorrectKey=null, lock=false;
  let timer=null, timeLeft=60, totalQuestions=10, asked=0, active=false;
  let fireworksEndAt=0, particles=[]; let kazooMode=(localStorage.getItem('quiz.kazoo')==='1');

  // ---------- Audio ----------
  let audioCtx; function ensureCtx(){try{audioCtx=audioCtx||new (window.AudioContext||window.webkitAudioContext)()}catch(e){}}
  function unlockAudio(){ensureCtx(); if(audioCtx && audioCtx.state==='suspended'){audioCtx.resume()}}
  window.addEventListener('pointerdown', unlockAudio, {once:true});

  function successChime(){ensureCtx();unlockAudio();if(!audioCtx) return; const now=audioCtx.currentTime;
    [523.25,659.25,783.99].forEach((f,i)=>{const o=audioCtx.createOscillator();const g=audioCtx.createGain();o.type=i===0?'sine':(i===1?'triangle':'square');o.frequency.setValueAtTime(f,now);g.gain.setValueAtTime(0.0001,now);g.gain.exponentialRampToValueAtTime(0.35,now+0.04);g.gain.exponentialRampToValueAtTime(0.0001,now+0.38);o.connect(g).connect(audioCtx.destination);o.start(now);o.stop(now+0.4)});
    const blip=audioCtx.createOscillator(), bl=audioCtx.createGain(); blip.type='square'; blip.frequency.setValueAtTime(2000,now); bl.gain.setValueAtTime(0.0001,now); bl.gain.exponentialRampToValueAtTime(0.06,now+0.005); bl.gain.exponentialRampToValueAtTime(0.0001,now+0.03); blip.connect(bl).connect(audioCtx.destination); blip.start(now); blip.stop(now+0.04);
  }
  function wrongBuzz(){
    ensureCtx(); unlockAudio(); if(!audioCtx) return;
    const now = audioCtx.currentTime;
    const master = audioCtx.createGain(); master.gain.setValueAtTime(1.0, now);
    const comp = audioCtx.createDynamicsCompressor();
    comp.threshold.value = -18; comp.knee.value = 30; comp.ratio.value = 16; comp.attack.value = 0.002; comp.release.value = 0.2;
    const post = audioCtx.createGain(); post.gain.setValueAtTime(1.6, now);
    master.connect(comp).connect(post).connect(audioCtx.destination);
    const o1 = audioCtx.createOscillator(), g1 = audioCtx.createGain();
    o1.type='square'; o1.frequency.setValueAtTime(320, now); o1.frequency.exponentialRampToValueAtTime(150, now+0.32);
    g1.gain.setValueAtTime(0.0001, now); g1.gain.exponentialRampToValueAtTime(1.0, now+0.015); g1.gain.exponentialRampToValueAtTime(0.0001, now+0.38);
    o1.connect(g1).connect(master);
    const o2 = audioCtx.createOscillator(), g2 = audioCtx.createGain();
    o2.type='sawtooth'; o2.frequency.setValueAtTime(520, now); o2.frequency.exponentialRampToValueAtTime(220, now+0.34);
    g2.gain.setValueAtTime(0.0001, now); g2.gain.exponentialRampToValueAtTime(0.9, now+0.02); g2.gain.exponentialRampToValueAtTime(0.0001, now+0.4);
    o2.connect(g2).connect(master);
    const noise = audioCtx.createBufferSource();
    const buffer = audioCtx.createBuffer(1, audioCtx.sampleRate*0.18, audioCtx.sampleRate);
    const data = buffer.getChannelData(0);
    for (let i=0; i<data.length; i++){ data[i] = (Math.random()*2-1) * 0.7; }
    noise.buffer = buffer;
    const hp = audioCtx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value = 400;
    const gn = audioCtx.createGain(); gn.gain.setValueAtTime(0.0001, now); gn.gain.exponentialRampToValueAtTime(0.9, now+0.008); gn.gain.exponentialRampToValueAtTime(0.0001, now+0.22);
    noise.connect(hp).connect(gn).connect(master);
    o1.start(now); o2.start(now); noise.start(now);
    o1.stop(now+0.42); o2.stop(now+0.42); noise.stop(now+0.24);
    if (navigator.vibrate) navigator.vibrate(160);
  }
  function fanfareDefault(){ensureCtx();unlockAudio();if(!audioCtx) return; const now=audioCtx.currentTime; [392,494,523,659,784,1046].forEach((f,i)=>{const o=audioCtx.createOscillator(),g=audioCtx.createGain(); o.type='square'; o.frequency.setValueAtTime(f,now+i*0.12); g.gain.setValueAtTime(0.0001,now+i*0.12); g.gain.exponentialRampToValueAtTime(0.28,now+i*0.12+0.04); g.gain.exponentialRampToValueAtTime(0.0001,now+i*0.12+0.36); o.connect(g).connect(audioCtx.destination); o.start(now+i*0.12); o.stop(now+i*0.12+0.36)}) }
  function fanfareKazoo(){ensureCtx();unlockAudio();if(!audioCtx) return; const now=audioCtx.currentTime; [392,494,523,659,784,1046].forEach((f,i)=>{const o=audioCtx.createOscillator(),g=audioCtx.createGain(),bp=audioCtx.createBiquadFilter(),l=audioCtx.createOscillator(),lg=audioCtx.createGain(); o.type='sawtooth'; o.frequency.setValueAtTime(f,now+i*0.12); bp.type='bandpass'; bp.frequency.value=800; bp.Q.value=10; l.frequency.value=18; lg.gain.value=6; l.connect(lg).connect(o.frequency); g.gain.setValueAtTime(0.0001,now+i*0.12); g.gain.exponentialRampToValueAtTime(0.24,now+i*0.12+0.04); g.gain.exponentialRampToValueAtTime(0.0001,now+i*0.12+0.36); o.connect(bp).connect(g).connect(audioCtx.destination); o.start(now+i*0.12); l.start(now+i*0.12); o.stop(now+i*0.12+0.38); l.stop(now+i*0.12+0.38) }) }
  function fanfareSad(){ ensureCtx(); unlockAudio(); if(!audioCtx) return; const now=audioCtx.currentTime; [[523,0.0,0.35],[392,0.18,0.45]].forEach(([f,d,du])=>{ const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type='sine'; o.frequency.setValueAtTime(f, now+d); g.gain.setValueAtTime(0.0001, now+d); g.gain.exponentialRampToValueAtTime(0.22, now+d+0.03); g.gain.exponentialRampToValueAtTime(0.0001, now+d+du); o.connect(g).connect(audioCtx.destination); o.start(now+d); o.stop(now+d+du); }); }

  // ---------- Locale ----------
  function setDefaults(){const ls=localStorage; if(!ls.getItem('quiz.lang')) ls.setItem('quiz.lang','ja'); if(!ls.getItem('quiz.topic')) ls.setItem('quiz.topic','color'); if(!ls.getItem('quiz.mode')) ls.setItem('quiz.mode','easy'); if(!ls.getItem('quiz.numlvl')) ls.setItem('quiz.numlvl','1'); if(!ls.getItem('quiz.play')) ls.setItem('quiz.play','time'); if(!ls.getItem('quiz.sec')) ls.setItem('quiz.sec','60'); if(!ls.getItem('quiz.q')) ls.setItem('quiz.q','10'); }
  setDefaults();
  langSel.value=localStorage.getItem('quiz.lang'); topicSel.value=localStorage.getItem('quiz.topic'); modeSel.value=localStorage.getItem('quiz.mode'); numLvlSel.value=localStorage.getItem('quiz.numlvl'); playType.value=localStorage.getItem('quiz.play'); secSel.value=localStorage.getItem('quiz.sec'); qSel.value=localStorage.getItem('quiz.q');
  toggleTopicControls(); togglePlayControls(); applyLocale(true);

  function t(key){return I18N[langSel.value][key]}
  function applyLocale(initial=false){ document.title=(langSel.value==='ja')?'いろとかずー':'Color & Number Zoo'; titleEl.textContent=t('title'); langLabel.textContent=t('language'); topicLabel.textContent=t('topic'); modeLabel.textContent=t('mode'); numLvlLabel.textContent=t('numLevel'); playTypeLabel.textContent=t('playType'); timeLabel.textContent=t('time'); countLabel.textContent=t('count'); topicSel.options[0].textContent=I18N[langSel.value].topicColor; topicSel.options[1].textContent=I18N[langSel.value].topicNumber; modeSel.options[0].textContent=I18N[langSel.value].modes.easy; modeSel.options[1].textContent=I18N[langSel.value].modes.hard; modeSel.options[2].textContent=I18N[langSel.value].modes.stroop; const nopts=I18N[langSel.value].numLevelOpts; numLvlSel.options[0].textContent=nopts[0]; numLvlSel.options[1].textContent=nopts[1]; numLvlSel.options[2].textContent=nopts[2]; const popts=I18N[langSel.value].playTypeOpts; playType.options[0].textContent=popts[0]; playType.options[1].textContent=popts[1]; hint.textContent=I18N[langSel.value].hint; resultTitle.textContent=I18N[langSel.value].resultTitle; againBtn.textContent=I18N[langSel.value].playAgain; homeBtn.textContent=I18N[langSel.value].back; scoreUnit.textContent=I18N[langSel.value].points; startBtn.textContent=I18N[langSel.value].start; resetBtn.textContent=I18N[langSel.value].reset; if(active){ if(topicSel.value==='color'){ question.textContent=(modeSel.value==='stroop')?t('questionColorWord'):t('questionColorFill'); } else { question.textContent=t('questionNumber'); } } else { question.textContent=(langSel.value==='ja')?'すたーと を おしてね':'Tap Start to begin'; swatchText.style.display='block'; swatchText.style.color='#111'; swatchText.textContent=(langSel.value==='ja')?'いろとかずー':'Color & Number Zoo'; } if(!initial && active){ startGame(); } }

  // ---------- Helpers ----------
  function luminance(hex){const c=hex.replace('#',''); const r=parseInt(c.substr(0,2),16)/255,g=parseInt(c.substr(2,2),16)/255,b=parseInt(c.substr(4,2),16)/255; const a=[r,g,b].map(v=>(v<=0.03928)? v/12.92 : Math.pow((v+0.055)/1.055,2.4)); return 0.2126*a[0]+0.7152*a[1]+0.0722*a[2] }

  // ---------- Visual effects ----------
  const fctx=fireworksCanvas.getContext('2d');
  function fireConfetti(){ if (confetti) confetti.innerHTML=''; if (swatch){ swatch.classList.remove('flash'); void swatch.offsetWidth; swatch.classList.add('flash'); } }
  function resizeFireworks(){fireworksCanvas.width=resultPanel.clientWidth; fireworksCanvas.height=resultPanel.clientHeight}
  function launchFirework(){const cx=Math.random()*fireworksCanvas.width*0.8+fireworksCanvas.width*0.1; const cy=Math.random()*fireworksCanvas.height*0.4+fireworksCanvas.height*0.1; const colors=['#f87171','#34d399','#60a5fa','#ffeb3b','#a78bfa','#f472b6']; const count=40+Math.floor(Math.random()*30); for(let i=0;i<count;i++){const angle=Math.random()*Math.PI*2; const speed=1+Math.random()*3; particles.push({x:cx,y:cy,vx:Math.cos(angle)*speed,vy:Math.sin(angle)*speed,life:60+Math.random()*40,color:colors[Math.floor(Math.random()*colors.length)],size:2+Math.random()*2})} }
  function stepFireworks(){fctx.clearRect(0,0,fireworksCanvas.width,fireworksCanvas.height); particles.forEach(p=>{p.x+=p.vx;p.y+=p.vy;p.vy+=0.02;p.life--; fctx.globalAlpha=Math.max(p.life/100,0); fctx.fillStyle=p.color; fctx.beginPath(); fctx.arc(p.x,p.y,p.size,0,Math.PI*2); fctx.fill()}); particles=particles.filter(p=>p.life>0); if(Date.now()<fireworksEndAt){ if(Math.random()<0.2) launchFirework(); requestAnimationFrame(stepFireworks)} else if(particles.length){ requestAnimationFrame(stepFireworks)} }
  function startFireworks(ms=6000){resizeFireworks(); particles=[]; fireworksEndAt=Date.now()+ms; launchFirework(); requestAnimationFrame(stepFireworks); window.addEventListener('resize',()=>{if(resultPanel.style.display!=='none'){resizeFireworks()}},{once:true}) }

  // ---------- UI header helpers ----------
  function labelProgress(idx){ if(playType.value==='count'){ return `${idx}/${totalQuestions}` } else { return `Q ${idx}` } }
  function updateQHeader(){ if(active){ const idx=asked+1; qProgress.textContent=labelProgress(idx); if(playType.value==='time'){ qTimer.style.display='inline-block'; qTimer.textContent=fmtTime(timeLeft); } else { qTimer.style.display='none'; qTimer.textContent=''; } } else { qProgress.textContent=''; qTimer.textContent=''; qTimer.style.display='none'; } timerLbl.textContent=''; progressLbl.textContent=''; timerLbl.style.display='none'; progressLbl.style.display='none'; }
  function showSplash(){ active=false; question.textContent=(langSel.value==='ja')?'すたーと を おしてね':'Tap Start to begin'; swatch.style.background='linear-gradient(135deg,#fdfbfb 0%,#ebedee 100%)'; swatchText.style.display='block'; swatchText.style.color='#111'; swatchText.textContent=(langSel.value==='ja')?'いろとかずー':'Color & Number Zoo'; choicesWrap.innerHTML=''; updateQHeader(); }

  // ---------- Round logic ----------
  function newRound(){ if(!active) return; lock=false; feedback.textContent=''; if(topicSel.value==='color'){ buildColorRound() } else { buildNumberRound() } updateQHeader(); }

  function buildColorRound(){ if(modeSel.value==='stroop'){ const target=COLORS[Math.floor(Math.random()*COLORS.length)]; question.textContent=I18N[langSel.value].questionColorWord; swatch.style.background='#fff'; swatchText.style.display='block'; swatchText.textContent=target[langSel.value]; swatchText.style.color='#111'; currentCorrectKey=target.key; renderColorChoices(currentCorrectKey,true); } else { const target=COLORS[Math.floor(Math.random()*COLORS.length)]; question.textContent=I18N[langSel.value].questionColorFill; swatchText.style.display='none'; swatch.style.background=target.css; currentCorrectKey=target.key; renderColorChoices(currentCorrectKey,false) } }

  function renderColorChoices(correctKey,colorOnly){ const pool=COLORS.slice(); const correct=pool.find(c=>c.key===correctKey); const wrongs=pool.filter(c=>c.key!==correctKey).sort(()=>Math.random()-0.5).slice(0,2); const all=[correct,...wrongs].sort(()=>Math.random()-0.5); choicesWrap.innerHTML=''; all.forEach(color=>{ const btn=document.createElement('button'); btn.className='choice'; btn.setAttribute('data-key',color.key); if(colorOnly){ btn.classList.add('color-only'); btn.textContent=''; btn.setAttribute('aria-label', color[langSel.value]); btn.style.background=color.css; btn.style.color=luminance(color.css)>0.5?'#111':'#fff'; } else if(modeSel.value==='easy'){ btn.textContent=color[langSel.value]; btn.style.color=color.css; btn.classList.add('colored-text'); btn.style.background='#fff'; } else { btn.textContent=color[langSel.value]; btn.style.color='#111'; btn.style.background='#fff'; } btn.addEventListener('click',()=>{ unlockAudio(); onChoice(color.key,color.css) }); choicesWrap.appendChild(btn) }) }

  function buildNumberRound(){ const lvl=parseInt(numLvlSel.value,10); let pool=[]; if(lvl===1){ pool=NUM_BASE.filter(x=>x.num<=10) } else if(lvl===2){ pool=NUM_BASE } else { const specials=(langSel.value==='ja')?NUM_SPECIAL_JA:NUM_SPECIAL_EN; pool=NUM_BASE.concat(specials) } const target=pool[Math.floor(Math.random()*pool.length)]; currentCorrectKey='num:'+target.num; swatch.style.background='#fff'; swatchText.style.display='block'; swatchText.style.color='#111'; swatchText.textContent=(langSel.value==='ja'? target.num.toLocaleString('ja-JP') : target.num.toLocaleString('en-US')); renderNumberChoices(target,pool) }

  function renderNumberChoices(target,pool){ const wrongs=pool.filter(x=>x.num!==target.num).sort(()=>Math.random()-0.5).slice(0,2); const all=[target,...wrongs].sort(()=>Math.random()-0.5); choicesWrap.innerHTML=''; all.forEach(item=>{ const btn=document.createElement('button'); btn.className='choice'; btn.textContent=(langSel.value==='ja')?item.ja:item.en; btn.addEventListener('click',()=>{ unlockAudio(); onChoice('num:'+item.num,'#10b981') }); choicesWrap.appendChild(btn) }) }

  function onChoice(key, cssColor){ if(!active||lock) return; lock=true; if(key===currentCorrectKey){ score++; streak++; bestStreak=Math.max(bestStreak,streak); } else { streak=0; } asked++; scoreLbl.textContent=String(score); streakLbl.textContent=`${streak} 🔥`; feedback.textContent=(key===currentCorrectKey)? I18N[langSel.value].correct : I18N[langSel.value].wrong; (key===currentCorrectKey? successChime() : wrongBuzz()); if(key===currentCorrectKey) fireConfetti(cssColor||'#10b981'); [...choicesWrap.children].forEach(b=>b.setAttribute('disabled','true')); setTimeout(()=>{ [...choicesWrap.children].forEach(b=>b.removeAttribute('disabled')); nextStep(); }, 700) }

  function nextStep(){ if(playType.value==='count' && asked>=totalQuestions){ endGame('count') } else { newRound(); ensureRoundRendered(); } }

  function startGame(){ unlockAudio(); if(active) stopTimer(); score=0; streak=0; bestStreak=0; asked=0; scoreLbl.textContent='0'; streakLbl.textContent='0 🔥'; feedback.textContent=(langSel.value==='ja')?'すたーと！':'Start!'; active=true; resultPanel.style.display='none'; gamePanel.style.display='block'; timerLbl.textContent=''; progressLbl.textContent=''; if(playType.value==='time'){ timeLeft=parseInt(secSel.value,10); qTimer.style.display='inline-block'; qTimer.textContent=fmtTime(timeLeft); startTimer(); } else { totalQuestions=parseInt(qSel.value,10); qTimer.style.display='none'; qTimer.textContent=''; } updateQHeader(); newRound(); ensureRoundRendered(); setTimeout(()=>{ if(feedback.textContent===(langSel.value==='ja'?'すたーと！':'Start!')) feedback.textContent=''; }, 1200); }

  function endGame(kind){ active=false; stopTimer(); const denom=(kind==='count')? totalQuestions : asked; const acc=denom? (score/denom) : 0; const msg=(kind==='time')? I18N[langSel.value].finishedTime(score) : I18N[langSel.value].finishedCount(score,totalQuestions); resultText.textContent=msg; document.getElementById('resultDetails').textContent = I18N[langSel.value].resultDetails(score, denom); resultStreak.textContent=I18N[langSel.value].bestStreak(bestStreak); gamePanel.style.display='none'; resultPanel.style.display='grid'; if(acc>=1){ (kazooMode?fanfareKazoo():fanfareDefault()); startFireworks(6000); } else if(acc<=0.5){ fanfareSad(); } else { fanfareDefault(); celebrateResultConfetti(); } }

  function reset(){ active=false; stopTimer(); score=0; streak=0; asked=0; scoreLbl.textContent='0'; streakLbl.textContent='0 🔥'; feedback.textContent=''; timerLbl.textContent=''; progressLbl.textContent=''; resultPanel.style.display='none'; gamePanel.style.display='block'; confetti.innerHTML=''; showSplash(); }

  function fmtTime(s){ const m=Math.floor(s/60).toString().padStart(2,'0'); const ss=(s%60).toString().padStart(2,'0'); return `${m}:${ss}` }
  function startTimer(){ stopTimer(); timer=setInterval(()=>{ timeLeft--; qTimer.style.display='inline-block'; qTimer.textContent=fmtTime(timeLeft); timerLbl.textContent=''; if(timeLeft<=0){ endGame('time') } },1000) }
  function stopTimer(){ if(timer){ clearInterval(timer); timer=null } }
  function togglePlayControls(){ if(playType.value==='time'){ timeWrap.style.display='inline-flex'; countWrap.style.display='none' } else { countWrap.style.display='inline-flex'; timeWrap.style.display='none' } updateQHeader(); }
  function toggleTopicControls(){ if(topicSel.value==='color'){ colorControls.style.display='inline-flex'; numberControls.style.display='none' } else { numberControls.style.display='inline-flex'; colorControls.style.display='none' } }

  // ---------- Events ----------
  langSel.addEventListener('change',()=>{ localStorage.setItem('quiz.lang',langSel.value); applyLocale() });
  topicSel.addEventListener('change',()=>{ localStorage.setItem('quiz.topic',topicSel.value); toggleTopicControls(); applyLocale(); if(active) startGame() });
  modeSel.addEventListener('change',()=>{ localStorage.setItem('quiz.mode',modeSel.value); applyLocale(); if(active) startGame() });
  numLvlSel.addEventListener('change',()=>{ localStorage.setItem('quiz.numlvl',numLvlSel.value); if(active) startGame() });
  playType.addEventListener('change',()=>{ localStorage.setItem('quiz.play',playType.value); togglePlayControls(); if(active) startGame() });
  secSel.addEventListener('change',()=>{ localStorage.setItem('quiz.sec',secSel.value); if(active && playType.value==='time') startGame() });
  qSel.addEventListener('change',()=>{ localStorage.setItem('quiz.q',qSel.value); if(active && playType.value==='count') startGame() });
  resetBtn.addEventListener('click', reset);
  startBtn.addEventListener('click',()=>{ unlockAudio(); startGame() });
  againBtn.addEventListener('click',()=>{ unlockAudio(); startGame() });
  homeBtn.addEventListener('click', reset);

  // Secret toggle: title 5 taps
  let tapCount=0, tapTimer=null; titleEl.addEventListener('click',()=>{ unlockAudio(); tapCount++; if(!tapTimer){ tapTimer=setTimeout(()=>{tapCount=0; tapTimer=null},1200) } if(tapCount>=5){ kazooMode=!kazooMode; localStorage.setItem('quiz.kazoo',kazooMode?'1':'0'); const msg=kazooMode?I18N[langSel.value].secretOn:I18N[langSel.value].secretOff; feedback.textContent=msg; setTimeout(()=>{ if(feedback.textContent===msg) feedback.textContent='' },1500); tapCount=0; clearTimeout(tapTimer); tapTimer=null } });

  // Global error traps
  window.onerror = function(msg, src, line, col){ const m = (msg||'error') + (line?` @${line}:${col||0}`:''); const txt = (langSel && langSel.value==='ja')? 'エラー: '+m : 'Error: '+m; const fb = document.getElementById('feedback'); if(fb){ fb.textContent = txt; setTimeout(()=>{ if(fb.textContent===txt) fb.textContent=''; }, 4000);} return false; };
  window.addEventListener('unhandledrejection', (e)=>{ const msg = (langSel && langSel.value==='ja')? 'エラー: 約束の失敗' : 'Error: Unhandled promise'; const fb = document.getElementById('feedback'); if(fb){ fb.textContent = msg; setTimeout(()=>{ if(fb.textContent===msg) fb.textContent=''; }, 4000);} });

  // ---------- Init ----------
  showSplash();

  // ---------- Result Confetti ----------
  function celebrateResultConfetti(){ if(!resultConfetti) return; resultConfetti.innerHTML=''; const colors=['#f87171','#34d399','#60a5fa','#ffeb3b','#a78bfa','#f472b6']; const N=220; for(let i=0;i<N;i++){ const s=document.createElement('span'); s.style.left=(Math.random()*100)+'%'; s.style.top=(Math.random()*60)+'%'; const ang=Math.random()*Math.PI*2; s.style.setProperty('--x',Math.cos(ang).toFixed(2)); s.style.setProperty('--y',Math.sin(ang).toFixed(2)); s.style.background=colors[i%colors.length]; s.style.animationDuration='1.6s'; resultConfetti.appendChild(s); } setTimeout(()=>{ if(resultConfetti) resultConfetti.innerHTML=''; },2800); }

  // ---------- Self-tests (optional) ----------
  function ensureRoundRendered(){ setTimeout(()=>{ if(!active) return; if(choicesWrap.children.length===0){ newRound(); setTimeout(()=>{ if(choicesWrap.children.length===0){ if(topicSel.value==='color') buildColorRound(); else buildNumberRound(); } },250); } },120); }
  function runSelfTests(){ const results=[]; const ok=(n,c)=>results.push([n,!!c]); ok('celebrateResultConfetti defined', typeof celebrateResultConfetti==='function'); ok('resultText exists', !!document.getElementById('resultText')); ok('labelProgress time', (playType.value='time', labelProgress(3)==='Q 3')); totalQuestions=10; ok('labelProgress count', (playType.value='count', labelProgress(1)==='1/10')); const before = document.getElementById('confetti').children.length; fireConfetti('#f00'); const after = document.getElementById('confetti').children.length; ok('fireConfetti is flash-only', before===after); try{ asked=3; score=2; active=true; endGame('time'); const expected = I18N[langSel.value].resultDetails(2,3); const got = document.getElementById('resultDetails').textContent; ok('resultDetails uses asked (time mode)', got===expected); } catch(e){ ok('resultDetails uses asked (time mode)', false) } finally { reset(); } console.log('[Irotokazoo tests]', results.map(([n,p])=>`${p?'✅':'❌'} ${n}`).join('\n')); const failed=results.filter(r=>!r[1]); if(failed.length){ const fb=document.getElementById('feedback'); if(fb){ fb.textContent='テストNG: '+failed.map(f=>f[0]).join(', '); setTimeout(()=>{ if(fb.textContent.startsWith('テストNG')) fb.textContent=''; },4000);} } }
  if(location.hash.includes('test')) runSelfTests();
})(); });
</script>
</body>
</html>
